# Test View Snapshot Feature
name: Test View Snapshot

on:
  pull_request:
    paths:
      - 'pkg/unikontainers/snapshot/**'
      - 'pkg/unikontainers/block*.go'

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.24'
      - name: Run snapshot package tests
        run: go test -v ./pkg/unikontainers/snapshot/...

  integration-devmapper:
    name: Integration (devmapper)
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.24'
      - name: Install dependencies
        run: sudo apt-get install -y thin-provisioning-tools lvm2
      - name: Setup devmapper
        run: sudo ./script/dm_create.sh
      - name: Configure containerd
        run: |
          sudo tee -a /etc/containerd/config.toml << EOF
          [plugins.'io.containerd.snapshotter.v1.devmapper']
            pool_name = "urunc-thinpool"
            base_image_size = "10GB"
          EOF
          sudo systemctl restart containerd
      - name: Build and install urunc
        run: |
          make static
          sudo make install
      - name: Run e2e tests
        run: make test_nerdctl_Rumprun
        env:
          SNAPSHOTTER: devmapper

  verify-no-run-copies:
    name: Verify /run cleanup
    runs-on: ubuntu-latest
    needs: integration-devmapper
    steps:
      - uses: actions/checkout@v4
      - name: Check /run usage
        run: |
          echo "Verifying /run is not filling up..."
          ls -la /run/urunc/ 2>/dev/null || echo "No leftover files - cleanup working!"
